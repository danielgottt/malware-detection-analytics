######################################################################################################################

https://reconshell.com/cve-2022-29464-wso2-rce-exploit/
https://www.rapid7.com/blog/post/2022/04/22/opportunistic-exploitation-of-wso2-cve-2022-29464/
https://github.com/hakivvi/CVE-2022-29464

######################################################################################################################
# Hits for potential file uploads

		alert tcp $EXTERNAL_NET any -> $HOME_NET any(msg:"CVE-2022-29464 RCE Attempt"; \
		flow:to_server, established; \
		content:"POST"; http_method; \
		content:"|2f|fileupload|2f|; http.uri; \
		content:"Content|2d|Disposition|3a|"; content:"name|3d 22|"; within:25;  \
		priority:2; \
		metadata: Not tested for FP rate or accuracy; \
		reference:url,https://www.rapid7.com/blog/post/2022/04/22/opportunistic-exploitation-of-wso2-cve-2022-29464/, CVE-2022-29464; \
		sid:1000008; rev:1;) \
		
		
# Hits for potential webshells written with the file extension .jsp (I dont like the within too much here)

		alert tcp $EXTERNAL_NET any -> $HOME_NET any(msg:"CVE-2022-29464 RCE Attempt"; \
		flow:to_server, established; \
		content:"POST"; http_method; \
		content:"|2f|fileupload|2f|; http.uri; \
		content:"Content|2d|Disposition|3a|"; pcre:"/[0-9a-zA-Z]{1,30}\.jsp/"; within:50;  \
		priority:2; \
		metadata: Not tested for FP rate or accuracy; \
		reference:url,https://www.rapid7.com/blog/post/2022/04/22/opportunistic-exploitation-of-wso2-cve-2022-29464/, CVE-2022-29464; \
		sid:1000009; rev:1;) \
		
# Looks for the 'filename="' and a file with the extension .jsp right after

		alert tcp $EXTERNAL_NET any -> $HOME_NET any(msg:"CVE-2022-29464 RCE Attempt"; \
		flow:to_server, established; \
		content:"POST"; http_method; \
		content:"|2f|fileupload|2f|; http.uri; \
		content:"filename|3d 22|"; pcre:"/[0-9a-zA-Z]{1,50}\.jsp"/" distance:0; \
		priority:2; \
		metadata: Not tested for FP rate or accuracy; \
		reference:url,https://www.rapid7.com/blog/post/2022/04/22/opportunistic-exploitation-of-wso2-cve-2022-29464/, CVE-2022-29464; \
		sid:1000010; rev:1;) \
		
		
Way forward
- Potential issues with these rules are the "within" keyword not actually being relevant. You should use data to determine your distance or even offset.
- Not all webshells have the file extension .jsp and the within clause again, could potentially hinder detection. Static file detections are quick wins but not long term solutions.
