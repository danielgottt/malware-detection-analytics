title: Persistence via public facing RDP port
id: 6736a69d-c24e-4584-8639-d5985925fb55
description: |
    Detects an attempt to open a port on a host firewall and enable remote desktop services
references:
  - https://threathunterplaybook.com/notebooks/windows/05_defense_evasion/WIN-190407183310.html
  - https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/microsoft-windows-terminalservices-localsessionmanager-fdenytsconnections
  - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.001/T1021.001.md#atomic-test-1---rdp-to-domaincontroller
status: experimental
Author: '@gott_cyber'
date: 2022/08/15
tags:
  - attack.persistence
  - attack.t1021.001
logsource:
    category: registry_set
    product: windows
detection:
    selection_1:
        EventType: SetValue
        TargetObject: 
            - 'HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\PortNumber'
    selection_2:
        EventType: SetValue
        TargetObject: 
            - 'SYSTEM\CurrentControlSet\Control\Terminal Server\'
            - 'SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\'
        TargetObject|endswith: 
            - '\fDenyTSConnections'
            - '\fSingleSessionPerUser'
        Details:
            - 'DWORD (0x00000000)'
    condition: selection_1 and selection_2
falsepositives: unkown
level: medium
